import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3000;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

/* ================= FRONTEND ================= */

app.get("/", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Currículo com IA</title>
<style>
  body {
    background: #e5e7eb;
    font-family: Arial, sans-serif;
  }
  .box {
    max-width: 600px;
    margin: 40px auto;
    background: #f9fafb;
    padding: 25px;
    border: 2px solid #2563eb;
    border-radius: 10px;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin-bottom: 15px;
    padding: 10px;
    border: 2px solid #2563eb;
    border-radius: 6px;
  }
  button {
    background: #2563eb;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    font-size: 16px;
  }
  #timer {
    margin-top: 15px;
    font-weight: bold;
    color: #2563eb;
  }
  #resultado {
    margin-top: 15px;
    padding: 15px;
    border: 2px solid #2563eb;
    border-radius: 6px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>

<div class="box">
  <h2>Seu currículo feito sob medida para cada vaga</h2>

  <label>Seu currículo</label>
  <textarea id="curriculo"></textarea>

  <label>Descrição da vaga</label>
  <textarea id="vaga"></textarea>

  <button onclick="gerar()">Gerar currículo otimizado</button>

  <div id="timer"></div>
  <div id="resultado">Aguardando...</div>
</div>

<script>
let respostaIA = null;
let intervalo = null;

async function gerar() {
  const resultado = document.getElementById("resultado");
  const timer = document.getElementById("timer");

  respostaIA = null;
  resultado.innerText = "⏳ Processando currículo com IA...";

  let tempo = 30;
  timer.innerText = "⏳ Gerando... " + tempo + "s";

  clearInterval(intervalo);

  fetch("/gerar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      curriculo: document.getElementById("curriculo").value,
      vaga: document.getElementById("vaga").value
    })
  })
  .then(res => res.json())
  .then(data => {
    respostaIA = data.resultado;
  });

  intervalo = setInterval(() => {
    tempo--;
    timer.innerText = "⏳ Gerando... " + tempo + "s";

    if (tempo <= 0) {
      clearInterval(intervalo);
      timer.innerText = "✅ Concluído";
      resultado.innerText = respostaIA || "Erro ao gerar currículo.";
    }
  }, 1000);
}
</script>

</body>
</html>
`);
});

/* ================= BACKEND + IA ================= */

app.post("/gerar", async (req, res) => {
  const { curriculo, vaga } = req.body;

  if (!curriculo || !vaga) {
    return res.json({ resultado: "Preencha o currículo e a vaga." });
  }

  const prompt = `
Você é um recrutador especialista em ATS.

Reescreva o currículo abaixo para a vaga informada.

REGRAS OBRIGATÓRIAS:
- Retorne APENAS o currículo final
- NÃO escreva títulos, explicações ou comentários
- NÃO diga "Aqui está" ou semelhantes
- Linguagem profissional e direta
- Destaque palavras-chave da vaga
- Não invente experiências

CURRÍCULO:
${curriculo}

VAGA:
${vaga}
`;

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${OPENAI_API_KEY}\`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: prompt }]
      })
    });

    const data = await response.json();
    res.json({ resultado: data.choices[0].message.content.trim() });

  } catch (err) {
    res.json({ resultado: "Erro ao gerar currículo." });
  }
});

/* ================= SERVER ================= */

app.listen(PORT, () => {
  console.log("Servidor rodando na porta " + PORT);
});
